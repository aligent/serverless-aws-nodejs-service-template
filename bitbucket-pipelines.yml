image: node:18

definitions:
  services:
    docker:
      memory: 3072
  steps:
    - step: &install
        name: ‚öôÔ∏è Install
        script:
          - npm ci
        artifacts:
          - node_modules/**
    - step: &lint
        name: üßπ Lint
        script:
          - npm run lint
          - npm run format
          - npm run check-types
    - step: &test
        name: üß™ Test
        script:
          - npm run test
    - step: &deploy-temp-stack
        name: üèóÔ∏è Test Deployment
        script:
          - TMP_STAGE=$(cat /dev/urandom | tr -dc 'a-z' | head -c3 | grep -vE 'prd|stg')
          - echo "Deploy temporary service to stage:\ $TMP_STAGE"
          - pipe: docker://aligent/serverless-deploy-pipe:latest-node18
            variables:
              AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
              AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
              CFN_ROLE: ${CFN_ROLE}
              DEBUG: ${CI_DEBUG}
              STAGE: ${TMP_STAGE}
          - pipe: docker://aligent/serverless-deploy-pipe:latest-node18
            variables:
              AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
              AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
              CFN_ROLE: ${CFN_ROLE}
              DEBUG: ${CI_DEBUG}
              CMD: 'remove'
              STAGE: ${TMP_STAGE}
        artifacts:
          download: false
    - step: &push-serverless
        name: üöÄ Deploy Service
        script:
          - pipe: docker://aligent/nx-serverless-deploy-pipe:18-alpine
            variables:
              AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
              AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
              CFN_ROLE: ${CFN_ROLE}
              STAGE: ${STAGE}
              DEBUG: ${CI_DEBUG}
              UPLOAD_BADGE: 'true'
              APP_USERNAME: ${APP_USERNAME}
              APP_PASSWORD: ${APP_PASSWORD}

pipelines:
  pull-requests:
    '**':
      - step: *install
      - parallel:
          steps:
            - step: *test
            - step: *lint
            - step: *deploy-temp-stack
  branches:
    production:
      - step:
          <<: *push-serverless
          name: 'Deploy Production'
          deployment: Production
    staging:
      - step:
          <<: *push-serverless
          name: 'Deploy Staging'
          deployment: Staging
