# Aligent AWS microservices template using Typescript and Serverless Framework

A template for developing a suite of AWS microservices using Typescript and [AWS CDK](https://docs.aws.amazon.com/cdk/v2/guide/home.html).

The monorepo workspace is managed using [Nx.](https://nx.dev)

## Setup

1. Update application name in `package.json`.

   It's recommend to have the name in the format of: `@<brand-name>-int/integrations`

   Example: `@aligent-int/integrations`

2. Update brand name in `nx.json`. The naming convention for this is: `<brand-name>-int`. Just be mindful about the length of service name.

   Example: `alg-int`

3. Install dependencies: `yarn install`

   You may need to run `nvm use` to ensure you're on a compatible version of NodeJS

## Services

Services are the core components deployed to AWS by the application

<details>

<summary>Instructions for working with services</summary>

[Add a service](#‚≠ê-adding-a-new-service) | [Test app](#üß™-testing-the-application) | [Deploy app](#üöÄ-playground-deploy-of-the-application) | [Clean up app](#üóëÔ∏è-clean-up-the-application-from-playground) | [Remove a service](#‚ùå-removing-a-service)

### ‚≠ê Adding a new service

Services are generated by our `@aligent/cdk-service-plugin`. It supports generating CDK-based services using predefined templates and executors as described below.

```bash
yarn nx g cdk-service
# You will be prompted to:
# 1. Enter the service name
# 2. Select the service type (general or notification)
```

Import and instantiate it in `application/lib/application-stage.ts`:

```typescript
import { YourServiceStack } from '@services/your-service-name';

export class ApplicationStage extends Stage {
  constructor(scope: Construct, stage: StageId, props?: StageProps) {
    super(scope, stage as string, props);

    new YourServiceStack(this, 'your-service-name', {
      ...props,
      description: 'Your service description',
    });
  }
}
```

---

### üß™ Testing the application

After adding a new service, test the application:

```bash
yarn lint        # Lint affected projects
yarn test        # Run tests for affected projects
yarn check-types # Type check affected projects
```

Post-fixing with `:all` will test the whole repository, not just recently affected parts

```bash
yarn test:all
```

---

### üöÄ Playground deploy of the application

Deploy the `stg` stage of your application to your `playground` AWS Profile:

```bash
yarn playground:deploy
# You may be prompted to confirm deployment of changes
```

If you need more control, arbitrary CDK commands can be run using the application project

```bash
yarn nx run application:cdk synth stg/**
```

---

### üóëÔ∏è Clean up the application from playground

During normal development CDK will remove resources that are no longer used by your application.

If necessary, the entire application can be removed from the account associated with your `playground` AWS profile:

```bash
yarn playground:destroy
# You will be prompted to confirm deletion of the stacks
```

---

### ‚ùå Removing a service

Always remove services using the Nx generator

```bash
npx nx g remove <service-name>
```

You may need to remove imports of the service from the application first

</details>

## Libraries

Libraries are located in the `libs` folder.

General libraries are generated by the `@nx/js` plugin. For more information, check out their [document](https://nx.dev/packages/js)

API clients libraries are generated by the `@aligent/openapi-plugin`

<details>

<summary>Instructions for working with libraries</summary>

[General library](#-generate-a-general-library) | [API Client](#-generate-an-api-client)

#### Generate a general library

`npx nx g library libs/<library-name>`

A few manual steps are then required as the `@nx/js` plugin does not handle them:

- Add the `check-types` command to ensure proper type checking.

```json
"check-types": {
  "executor": "nx:run-commands",
  "options": {
      "cwd": "{projectRoot}",
      "color": true,
      "command": "tsc --noEmit --pretty"
  },
}
```

- Set the module type in `tsconfig.json` needs to `"module": "Node16"`
- Rename `vite.config.ts` to `vite.config.mjs`
- Rename `eslint.config.js` to `eslint.config.mjs`
- Replace the content for these files with imports from the base configurations

```mjs
// vite.config.mjs
import { viteBaseConfig } from '../../vite.config.base.mjs';

export default {...viteBaseConfig};

// eslint.config.mjs
import baseConfig from '../../eslint.config.mjs';

export default [...baseConfig];

```

### Generate an API Client

`npx nx g client <client-name>`

Clients are generated by our `@aligent/openapi-plugin`. This plugin will generate typed API utilities to build an external API Client based on a local or remote OpenAPI Specification (3.0.0+) schema file (.json .yaml)

For more detailed documentation on using the plugin see the plugin README [here](./tools/openapi-plugin/README.md)

</details>

### General Nx. commands

Below are some example of general Nx. commands. For more information, check out their [document](https://nx.dev/packages/nx/documents).

- Remove a service or library:

  `npx nx g rm <project-name>`

- To run executors (`lint`, `test`, etc..) for all the projects:

  `npx nx run-many -t <list-of-executors-separated-by-space-or-comma>`

- To run executors for only affected projects:

  `npx nx affected -t <list-of-executors-separated-by-space-or-comma>`

## Notes:

- The `tsconfig.base.json` file extends [@aligent/ts-code-standard](https://bitbucket.org/aligent/ts-code-standards/src/main) package. Please note that there are settings which are not shown in that file but still applied. For more information on those settings, visit https://github.com/tsconfig/bases.

- Following `@aligent/ts-code-standard`, we switched to the new [Eslint's FlatConfig](https://eslint.org/blog/2022/08/new-config-system-part-2/). If you're using [VSCode's Eslint extension](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint), turn on the `eslint.useFlatConfig` setting.

## Maintenance

### Upgrading NPM packages

The NPM packages in `devDependencies` in this repository has a complicated relationship with each other. Therefore, upgrading them should be handled with care.

- All the `@nx` packages must be pinned at the same version with `nx` package to avoid conflict.

  ```json
    "@nx/devkit": "17.3.0",
    "@nx/esbuild": "17.3.0",
    "@nx/eslint": "17.3.0",
    "@nx/eslint-plugin": "17.3.0",
    "@nx/js": "17.3.0",
    "@nx/plugin": "17.3.0",
    "@nx/vite": "17.3.0",
    "@nx/workspace": "17.3.0",
    "nx": "17.3.0"
  ```

- All the packages that are in the same scope should be at the same version. For example:

  ```json
    "@typescript-eslint/eslint-plugin": "^6.13.2",
    "@typescript-eslint/parser": "^6.13.2",
  ```

- `@nx/esbuild` lists `esbuild` as peerDependency. Double check the required version of `esbuild` in `package.json` of this [package](https://www.npmjs.com/package/@nx/esbuild?activeTab=code) before upgrading.
- `eslint` and `prettier` are a peerDependencies of the following packages. Double check the required versions in `package.json` of these packages before upgrading.
  - [@aligent/ts-code-standard](https://bitbucket.org/aligent/ts-code-standards/src/main/package.json)
  - [eslint-plugin-import](https://www.npmjs.com/package/eslint-plugin-import?activeTab=code)
- `@nx/vite` lists `vite` and `vitest` as peerDependencies. Double check the required version of `vite` and `vitest` in `package.json` of this [package](https://www.npmjs.com/package/@nx/vite?activeTab=code) before upgrading.
  - `vitest`, `@vitest/coverage-v8` and `@vitest/ui` should be at the same version.

## Under development

- [-] Deployment pipeline -> nodeJS container + pnpm
- [x] Typescript compilation to check types (`tsc --noEmit`)
- [x] Root client configuration (e.g. service name prefix)
- [-] Base vite configuration -> this works for service generator.
- [ ] Importing code from internal libraries
- [ ] Bespoke library generator -> use same base vite configuration if we do this.
- [ ] Develop workspace [preset](https://nx.dev/extending-nx/recipes/create-preset)
- [x] Pre-commit hooks
- [x] Add error notification service
- [ ] Add step function metric configuration
