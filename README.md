# Aligent AWS Microservices template

A template for developing a suite of AWS microservices using [AWS CDK](https://docs.aws.amazon.com/cdk/v2/guide/home.html), [Typescript](https://www.typescriptlang.org/), and [Nx.](https://nx.dev)

## Setup

1. Update application name in `package.json`.

   It's recommend to have the name in the format of: `@<brand-name>-int/integrations`

   Example: `@aligent-int/integrations`

2. Install the template, then validate all code standard tests are passing

   ```bash
   nvm use && yarn install
   yarn audit
   ```

3. (Optional) Commit the initial state of the template. This ensures subsequent changes are easy to review, rather than getting lost in the template boilerplate

   ```bash
   git add . && git commit -m 'Serverless application template'
   ```

4. (Optional) Bootstrap SSM parameters:

   If there are existing parameters in SSM Parameter store, import them

   ```bash
   yarn nx run core:parameters
   ```

   Alternatively, copy the `parameters/.env.example.csv` file to `parameters/.env.csv` in the
   application project, modify the contents, and push the parameters to AWS

   ```bash
   yarn nx run core:parameters:import
   ```

   The default SSM path and file path can be changed in an application's `parameters` target or via CLI arguments

5. (Optional) Change default base branch
   If your pull requests will target a branch other than `main`, change the value of `defaultBranch` in `nx.json` to the name of the branch that Nx should compare to when running tasks with `affected`

   ```json
   {
     "defaultBase": "origin/staging"
   }
   ```

## Services

Services are the core components deployed to AWS by the application

[Add a service](#‚≠ê-adding-a-new-service) | [Test app](#üß™-testing-the-application) | [Deploy app](#üöÄ-playground-deploy-of-the-application) | [Clean up app](#üóëÔ∏è-clean-up-the-application-from-playground) | [Remove a service](#‚ùå-removing-a-service) | [Mock Endpoints](#üß™-testing-with-mock-services)

### ‚≠ê Adding a new service

Services are generated by our `@tools/cdk-service-plugin`. It supports generating CDK-based services using predefined templates and executors as described below.

```bash
yarn nx g service
# You will be prompted to:
# 1. Enter the service name
# 2. Select the service type (general or notification)

# Alternatively, provide the name and type as arguments
yarn nx g service test-app --type=general
# Will create a project called @services/test-app in the services/ folder
```

Newly added service may not be detected by Nx immediately. You will need to update lockfile then reset Nx cache & stop its daemon and update Nx‚Äôs internal dependency graph and ensure your workspace is in sync.

```bash
# Update lockfile
yarn install

# Reset Nx cache and stop the daemon
yarn nx reset

# Update Nx's internal dependency graph and ensure workspace is in sync
yarn nx sync

# Alternatively, you can combine them into one line
yarn install && yarn nx reset && yarn nx sync
```

Import and instantiate the service in `ApplicationStage` inside `applications/core/bin/main.ts`:

```typescript
import { YourServiceStack } from '@services/your-service-name';

// Application setup here...

class ApplicationStage extends Stage {
  constructor(scope: Construct, id: string, props?: StageProps) {
    super(scope, id, props);

    Tags.of(this).add('STAGE', id);

    // Instantiate service stacks here as required..
    new YourServiceStack(this, 'your-service-name', {
      ...props,
      description: 'Your service description',
    });
  }
}
```

---

### üß™ Testing the application

After adding a new service, test the application:

```bash
yarn lint        # Lint affected projects
yarn test        # Run tests for affected projects
yarn typecheck   # Type check affected projects
```

By default, Nx will only test code impacted by recent changes to save time. Post-fixing with `:all` will test the whole repository, not just recently affected parts

```bash
yarn test:all
```

The `yarn audit` command is useful after making significant changes to ensure the entire repository is passing code checks

```bash
yarn audit
```

---

### üöÄ Playground deploy of the application

Deploy the `dev` stage of your application to your `playground` AWS Profile:

```bash
yarn pg:deploy
# You may be prompted to confirm deployment of changes
```

If you just want to check the CDK compilation process without deploying, use `yarn pg:synth`.

If you need more control, arbitrary CDK commands can be run using the core application project

```bash
yarn nx run core:cdk list prd/**
```

---

### üóëÔ∏è Clean up the application from playground

During normal development CDK will remove resources that are no longer used by your application.

If necessary, the entire application can be removed from the account associated with your `playground` AWS profile:

```bash
yarn pg:destroy
# You will be prompted to confirm deletion of the stacks
```

---

### ‚ùå Removing a service

Always remove services using the Nx generator

```bash
yarn nx g remove <service-name>
```

You may need to remove imports of the service from the application first.
You may need to remove references to the service in `nx.json` afterwards.
You may need to run `yarn install` to remove the service reference from the lock file.

### üß™ Testing with Mock Services

The application may include mock services for testing integrations without external dependencies

To switch between mock and real dependencies, change the value of the relevant url SSM Parameter.

## Libraries

Libraries are located in the `libs` folder.

General libraries are generated by the `@nx/js` plugin. For more information, check out their [document](https://nx.dev/packages/js)

API client libraries should be generated by the `@aligent/openapi-plugin`

[General library](#‚≠ê-adding-a-new-library) | [API Client](#üîå-adding-a-new-api-client) | [Remove a service](#‚ùå-removing-a-library)

### ‚≠ê Adding a new library

```bash
# Generates a non-buildable library with eslint, vitest
# Lives in a subfolder of 'libs'
# Import path defaults to @<brand-name>/<library-name>
yarn nx g library libs/<library-name>  --importPath=libs/<library-name>
```

---

### üîå Adding a new API client

```bash
yarn nx g client --name=<client-name> --schemaPath=<path-to-openapi-spec>
```

### ‚ùå Removing A Library

Always remove libraries using the Nx generator

```bash
yarn nx g remove <library-name>
```

You may need to remove imports of the library from the codebase first

## Working with Nx

## General commands

Below are some example of general Nx. commands. For more information, check out their [document](https://nx.dev/packages/nx/documents).

- Remove a service or library:

  `yarn nx g rm <project-name>`

- To run executors (`lint`, `test`, etc..) for all the projects:

  `yarn nx run-many -t <list-of-executors-separated-by-space-or-comma>`

- To run executors for only affected projects:

  `yarn nx affected -t <list-of-executors-separated-by-space-or-comma>`

### Troubleshooting

Reset all Nx project dependencies and caching: `yarn nx reset`

Ensure typescript project references are correct: `yarn nx sync`

Run test, lint, typecheck on all code without caching: `yarn lint:all --skip-nx-cache` etc.

### Notes

- This monorepo uses the new Nx [Typescript Project References setup](https://nx.dev/blog/typescript-project-references). This currently doesn't allow extending tsconfigs at all, so we are not extending `@aligent/ts-code-standard/tsconfigs-base`
- Following `@aligent/ts-code-standard`, we switched to the new [Eslint's FlatConfig](https://eslint.org/blog/2022/08/new-config-system-part-2/). If you're using [VSCode's Eslint extension](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint), turn on the `eslint.useFlatConfig` setting.

## Further documentation

[Architecture](./docs/developer-notes/ARCHITECTURE.md) | [Maintenance](./docs/developer-notes/MAINTENANCE.md) | [Future Development](./docs/developer-notes/FUTURE-DEVELOPMENT.md)
