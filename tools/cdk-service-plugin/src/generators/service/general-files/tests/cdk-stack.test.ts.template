import { LambdaFunction, MicroserviceChecks, StepFunctionFromFile } from '@libs/cdk-utils/infra';
import { App, Aspects, Duration, Stack } from 'aws-cdk-lib';
import { Annotations, Match, Template } from 'aws-cdk-lib/assertions';
import { Runtime, Tracing } from 'aws-cdk-lib/aws-lambda';
import { describe, expect, it } from 'vitest';
import { <%= name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('') %>Stack } from '../src/index';

let stack: Stack;
let template: Template;

beforeEach(() => {
    const app = new App({
        context: {
            ...LambdaFunction.defineContext({
                timeout: Duration.seconds(6),
                memorySize: 192,
                runtime: Runtime.NODEJS_20_X,
                tracing: Tracing.ACTIVE,
                reservedConcurrentExecutions: 10,
                environment: {
                    NODE_OPTIONS: '--enable-source-maps',
                },
                bundling: {
                    sourceMap: true,
                },
                alias: 'LATEST',
            }),
            ...StepFunctionFromFile.defineContext({
                tracingEnabled: true,
                alias: 'LATEST',
            }),
            configFileName: 'test-config.json',
            // This feature flag prevents bundling lambda functions when running tests
            'aws:cdk:bundling-stacks': [],
        },
    });

    stack = new <%= name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('') %>Stack(app, 'TestStack');

    Aspects.of(stack).add(new MicroserviceChecks());

    template = Template.fromStack(stack);
});

describe('CdkNag', () => {
    it('should pass Microservices cdk-nag checks', () => {
        const errors = Annotations.fromStack(stack).findError(
            '*',
            Match.stringLikeRegexp('Microservices.*')
        );

        if (errors.length > 0) {
            console.log(errors);
        }

        expect(
            errors,
            'Microservice checks failed - inspect console logs for details'
        ).toHaveLength(0);
    });
});

describe('<%= name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('') %>Stack', () => {
    it('should create a single S3 bucket', () => {
        template.resourceCountIs('AWS::S3::Bucket', 1);
    });

    it('should create a single DynamoDB table', () => {
        template.resourceCountIs('AWS::DynamoDB::Table', 1);
    });

    it('should create a single Lambda function', () => {
        template.resourceCountIs('AWS::Lambda::Function', 1);
    });

    it('should create a single Step Functions state machine', () => {
        template.resourceCountIs('AWS::StepFunctions::StateMachine', 1);
    });

    it('should configure Lambda function with proper environment variables', () => {
        template.hasResourceProperties('AWS::Lambda::Function', {
            Environment: {
                Variables: {
                    CONFIG_BUCKET: Match.anyValue(),
                    CACHE_TABLE: Match.anyValue(),
                    CONFIG_FILE_NAME: 'test-config.json',
                },
            },
        });
    });

    it('should use lambdaFunctions array approach for Step Function', () => {
        // The Step Function should not have DefinitionSubstitutions when using lambdaFunctions array
        template.hasResourceProperties('AWS::StepFunctions::StateMachine', {
            DefinitionString: Match.anyValue(),
        });
    });
});
